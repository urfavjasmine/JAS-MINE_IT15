@model JAS_MINE_IT15.Models.DashboardHomeViewModel
@using Microsoft.AspNetCore.Http
@using System.Linq
@using System.Text.Json

@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Display only (no backend)
    var userName = Context.Session.GetString("UserName") ?? "Jasminetampus30";
    var barangay = Context.Session.GetString("Barangay") ?? "Barangay San Antonio";
    var role = Context.Session.GetString("Role");

    var roleLabel = role switch
    {
        "super_admin" => "Super Admin",
        "barangay_admin" => "Barangay Admin",
        "barangay_secretary" => "Barangay Secretary",
        "barangay_staff" => "Barangay Staff",
        "council_member" => "Council Member",
        _ => "User"
    };

    // ===== Mock Recent Activity =====
    var recentActivity = new[]
    {
        new { Action = "Document uploaded", Item = "Resolution No. 2024-001", User = "Maria Santos", Time = "5 min ago",  Status = "pending" },
        new { Action = "Policy approved",   Item = "Waste Management Guidelines", User = "Juan dela Cruz", Time = "1 hour ago", Status = "approved" },
        new { Action = "Lesson submitted",  Item = "COVID-19 Response Insights", User = "Ana Reyes", Time = "2 hours ago", Status = "pending" },
        new { Action = "Best practice added", Item = "Community Health Program", User = "Pedro Garcia", Time = "3 hours ago", Status = "approved" },
        new { Action = "Document rejected", Item = "Budget Proposal Draft", User = "System", Time = "4 hours ago", Status = "rejected" },
    };

    // ===== Mock Announcements =====
    var announcements = new[]
    {
        new { Title = "System Maintenance Notice", Content = "Scheduled maintenance on February 15, 2024 from 10PM-12AM.", Priority = "info" },
        new { Title = "New Policy Guidelines Released", Content = "Updated guidelines for document submission now available.", Priority = "important" },
    };

    // ===== Barangay Admin Analytics =====
    var workflowStatus = new[]
    {
        new { Label = "Pending", Count = 12, Color = "bg-warning" },
        new { Label = "Approved", Count = 86, Color = "bg-success" },
        new { Label = "Rejected", Count = 7, Color = "bg-danger" }
    };

    var monthlyBarangayActivity = new[]
    {
        new { Month="Sep", Docs=20, Policies=5, Lessons=8, Practices=3 },
        new { Month="Oct", Docs=28, Policies=6, Lessons=12, Practices=4 },
        new { Month="Nov", Docs=24, Policies=7, Lessons=10, Practices=5 },
        new { Month="Dec", Docs=18, Policies=4, Lessons=6, Practices=2 },
        new { Month="Jan", Docs=30, Policies=8, Lessons=15, Practices=6 },
        new { Month="Feb", Docs=36, Policies=9, Lessons=18, Practices=7 },
    };

    // ===== Super Admin Analytics (Mock) =====
    var monthlyActivity = new[]
    {
        new { month = "Sep", documents = 85,  policies = 12, lessons = 28, practices = 15 },
        new { month = "Oct", documents = 102, policies = 8,  lessons = 35, practices = 18 },
        new { month = "Nov", documents = 95,  policies = 15, lessons = 42, practices = 22 },
        new { month = "Dec", documents = 78,  policies = 10, lessons = 30, practices = 12 },
        new { month = "Jan", documents = 120, policies = 14, lessons = 38, practices = 20 },
        new { month = "Feb", documents = 134, policies = 18, lessons = 45, practices = 25 },
    };

    var moduleUsage = new[]
    {
        new { name = "Repository", value = 42 },
        new { name = "Policies", value = 18 },
        new { name = "Lessons", value = 25 },
        new { name = "Best Practices", value = 15 },
    };

    var monthlyJson = JsonSerializer.Serialize(monthlyActivity);

    // keep your original line (uses Model.ModuleUsage)
    var usageJson = JsonSerializer.Serialize(Model?.ModuleUsage ?? new List<JAS_MINE_IT15.Models.ModuleUsageRow>());

    string StatusBadgeClass(string status)
    {
        return status switch
        {
            "approved" => "badge bg-success-subtle text-success border border-success-subtle",
            "pending" => "badge bg-warning-subtle text-warning border border-warning-subtle",
            "rejected" => "badge bg-danger-subtle text-danger border border-danger-subtle",
            _ => "badge bg-secondary-subtle text-secondary border border-secondary-subtle"
        };
    }

    string StatusIcon(string status)
    {
        return status switch
        {
            "approved" => "bi-check-circle text-success",
            "rejected" => "bi-exclamation-circle text-danger",
            _ => "bi-clock text-warning"
        };
    }
}

<style>
    /* Page spacing like screenshot */
    .dash-wrap {
        padding: 14px 6px;
    }

    .dash-title {
        font-size: 34px;
        font-weight: 800;
        margin-bottom: 4px;
    }

    .dash-sub {
        color: #6b778a;
        margin-bottom: 18px;
    }

    /* Stat cards */
    .stat-card {
        border: 1px solid #e6ebf2;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(16,24,40,.06);
        background: #fff;
    }

        .stat-card .stat-label {
            color: #6b778a;
            font-size: 14px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.1;
            margin-top: 6px;
        }

    /* Panels */
    .panel-card {
        border: 1px solid #e6ebf2;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(16,24,40,.06);
        background: #fff;
    }

    /* Recent activity items */
    .activity-item {
        padding: 14px 0;
        border-bottom: 1px solid #edf1f7;
    }

        .activity-item:last-child {
            border-bottom: 0;
        }

    .activity-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #f2f5f9;
    }

    /* Quick action buttons */
    .qa-btn {
        border-radius: 10px;
        border: 1px solid #e6ebf2;
        background: #fff;
        padding: 12px 14px;
        text-align: left;
        width: 100%;
    }

        .qa-btn:hover {
            background: #f7f9fc;
        }

    /* ===== Analytics styles ===== */
    .section-head {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 22px 0 12px;
        font-weight: 800;
        font-size: 18px;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 18px;
    }

    @@media (min-width: 992px) {
        .analytics-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .panel-head {
        padding: 16px 18px 10px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .panel-title {
        font-weight: 800;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
    }

    .panel-body {
        padding: 0 18px 18px 18px;
    }

    .chart-wrap {
        height: 280px;
    }

    .donut-wrap {
        display: grid;
        grid-template-columns: 1fr;
        gap: 14px;
        align-items: center;
    }

    @@media (min-width: 576px) {
        .donut-wrap {
            grid-template-columns: 240px 1fr;
        }
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
    }

    .legend-name {
        color: #556371;
        font-size: 14px;
    }

    .legend-val {
        margin-left: auto;
        font-weight: 800;
    }
</style>

<div class="dash-wrap">

    <!-- Header -->
    <div>
        <div class="dash-title">Dashboard</div>
        <div class="dash-sub">
            Welcome to JAS-MINE Knowledge Management System • @roleLabel
        </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">

        <!-- Documents -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="stat-card p-4 h-100">
                <div class="stat-label">Total Documents</div>
                <div class="stat-value">@Model.TotalDocuments</div>
            </div>
        </div>

        <!-- Policies -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="stat-card p-4 h-100">
                <div class="stat-label">Active Policies</div>
                <div class="stat-value">@Model.ActivePolicies</div>
            </div>
        </div>

        <!-- Lessons -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="stat-card p-4 h-100">
                <div class="stat-label">Lessons Learned</div>
                <div class="stat-value">@Model.LessonsLearned</div>
            </div>
        </div>

        <!-- Practices -->
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="stat-card p-4 h-100">
                <div class="stat-label">Best Practices</div>
                <div class="stat-value">@Model.BestPractices</div>
            </div>
        </div>

    </div>

    @* ===== Super Admin Analytics Section (Chart.js) ===== *@
    @if (role == "super_admin")
    {
        <div class="section-head">
            <i class="bi bi-bar-chart-line text-primary"></i>
            <span>System Analytics</span>
        </div>

        <div class="analytics-grid">

            <!-- Monthly Activity Trend -->
            <div class="panel-card">
                <div class="panel-head">
                    <div class="panel-title">
                        <i class="bi bi-activity text-muted"></i>
                        Monthly Activity Trend
                    </div>
                </div>
                <div class="panel-body">
                    <div class="chart-wrap">
                        <canvas id="monthlyActivityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Module Usage Distribution -->
            <div class="panel-card">
                <div class="panel-head">
                    <div class="panel-title">
                        <i class="bi bi-pie-chart text-muted"></i>
                        Module Usage Distribution
                    </div>
                </div>
                <div class="panel-body">
                    <div class="donut-wrap">
                        <div style="height:220px;">
                            <canvas id="moduleUsageChart"></canvas>
                        </div>
                        <div id="moduleUsageLegend"></div>
                    </div>
                </div>
            </div>

        </div>
    }

    @* ===== UPDATED: Super Admin views only (table + progress bars) ===== *@
    @if (role == "super_admin")
    {
        <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-3">
                <i class="bi bi-bar-chart-line text-muted"></i>
                <div class="fw-bold" style="font-size:18px;">
                    System Analytics
                </div>
            </div>

            <div class="row g-4">

                <!-- Monthly Activity Trend (table) -->
                <div class="col-12 col-lg-8">
                    <div class="panel-card p-4">
                        <div class="fw-semibold mb-3">Monthly Activity Trend</div>

                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Documents</th>
                                    <th>Policies</th>
                                    <th>Lessons</th>
                                    <th>Practices</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var m in Model.MonthlyActivity)
                                {
                                    <tr>
                                        <td>@m.Month</td>
                                        <td>@m.Documents</td>
                                        <td>@m.Policies</td>
                                        <td>@m.Lessons</td>
                                        <td>@m.Practices</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Module Usage (progress bars) -->
                <div class="col-12 col-lg-4">
                    <div class="panel-card p-4">
                        <div class="fw-semibold mb-3">Module Usage</div>

                        @{
                            var total = Model.ModuleUsage.Sum(x => x.Value);
                            if (total == 0) total = 1;
                        }

                        @foreach (var u in Model.ModuleUsage)
                        {
                            var pct = (int)Math.Round((u.Value * 100.0) / total);

                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>@u.Name</span>
                                    <span class="fw-bold">@pct%</span>
                                </div>
                                <div class="progress" style="height:8px;">
                                    <div class="progress-bar bg-primary" style="width:@pct%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    }

    <!-- Main Grid -->
    <div class="row g-4">

        <!-- Recent Activity (left) -->
        <div class="col-12 col-lg-8">
            <div class="panel-card">
                <div class="p-4 pb-2 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-clock text-muted"></i>
                        <div class="fw-bold" style="font-size:18px;">Recent Activity</div>
                    </div>

                    <a class="btn btn-link text-decoration-none fw-semibold" href="#" style="color:#163a5f;">
                        View all <i class="bi bi-arrow-right"></i>
                    </a>
                </div>

                <div class="px-4 pb-4">
                    @foreach (var a in recentActivity)
                    {
                        <div class="activity-item d-flex align-items-start gap-3">
                            <div class="activity-icon">
                                <i class="bi @StatusIcon(a.Status)"></i>
                            </div>

                            <div class="flex-grow-1" style="min-width:0;">
                                <div class="fw-semibold">@a.Action</div>
                                <div class="text-muted text-truncate">@a.Item</div>
                                <div class="text-muted" style="font-size:12px;margin-top:4px;">
                                    @a.User • @a.Time
                                </div>
                            </div>

                            <span class="@StatusBadgeClass(a.Status) px-3 py-2 rounded-pill" style="font-weight:600;">
                                @(a.Status == "approved" ? "Approved" : a.Status == "pending" ? "Pending" : "Rejected")
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-12 col-lg-4">
            <div class="d-flex flex-column gap-4">

                <!-- Announcements -->
                <div class="panel-card">
                    <div class="p-4 pb-2 d-flex align-items-center gap-2">
                        <i class="bi bi-people text-muted"></i>
                        <div class="fw-bold" style="font-size:18px;">Announcements</div>
                    </div>

                    <div class="p-4 pt-2 d-flex flex-column gap-3">
                        @foreach (var an in announcements)
                        {
                            var boxClass = an.Priority == "important"
                            ? "border border-success-subtle bg-success-subtle"
                            : "border border-secondary-subtle bg-light";

                            <div class="p-3 rounded-3 @boxClass">
                                <div class="fw-semibold">@an.Title</div>
                                <div class="text-muted" style="font-size:12px;margin-top:4px;">
                                    @an.Content
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- Chart.js (only needed once) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    (function () {
        const monthlyEl = document.getElementById("monthlyActivityChart");
        const usageEl = document.getElementById("moduleUsageChart");
        if (!monthlyEl || !usageEl) return; // not super_admin

        const monthlyData = @Html.Raw(monthlyJson);
        const usageData = @Html.Raw(usageJson);

        const labels = monthlyData.map(x => x.month);
        const docs = monthlyData.map(x => x.documents);
        const lessons = monthlyData.map(x => x.lessons);
        const practices = monthlyData.map(x => x.practices);

        // Monthly Activity Trend
        new Chart(monthlyEl, {
            type: "line",
            data: {
                labels,
                datasets: [
                    { label: "Documents", data: docs, fill: true, tension: 0.35, borderWidth: 2 },
                    { label: "Lessons", data: lessons, fill: true, tension: 0.35, borderWidth: 2 },
                    { label: "Best Practices", data: practices, fill: true, tension: 0.35, borderWidth: 2 },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                plugins: { legend: { display: false }, tooltip: { padding: 10 } },
                scales: {
                    x: { grid: { display: true } },
                    y: { beginAtZero: true, grid: { display: true } }
                },
                elements: { point: { radius: 0 } }
            }
        });

        // Module Usage Distribution (donut)
        const moduleLabels = usageData.map(x => x.name);
        const moduleValues = usageData.map(x => x.value);

        const fixedColors = ["#2b6cb0", "#38a169", "#eab308", "#0ea5e9"];

        new Chart(usageEl, {
            type: "doughnut",
            data: {
                labels: moduleLabels,
                datasets: [{
                    data: moduleValues,
                    backgroundColor: fixedColors,
                    borderWidth: 4,
                    hoverOffset: 6,
                    cutout: "65%"
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { padding: 10 } }
            }
        });

        // Legend list
        const legend = document.getElementById("moduleUsageLegend");
        legend.innerHTML = moduleLabels.map((name, i) => {
            const val = moduleValues[i];
            const c = fixedColors[i] || "#999";
            return `
              <div class="legend-item">
                <span class="legend-dot" style="background:${c}"></span>
                <span class="legend-name">${name}</span>
                <span class="legend-val">${val}%</span>
              </div>
            `;
        }).join("");
    })();
</script>
