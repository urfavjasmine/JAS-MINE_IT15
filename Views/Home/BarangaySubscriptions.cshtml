@model JAS_MINE_IT15.Models.BarangaySubscriptionsViewModel
@{
    ViewData["Title"] = "Barangay Subscriptions";
    Layout = "~/Views/Shared/_Layout.cshtml"; // use your layout (sidebar ok). Set Layout=null if you want no sidebar.
}

<style>
    .badge-active {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-expired {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-cancelled {
        background: #e5e7eb;
        color: #374151;
    }
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h2 class="mb-0 fw-bold">Barangay Subscriptions</h2>
        <div class="text-muted">Assign and manage subscription plans per barangay.</div>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
        + Assign Plan
    </button>
</div>

@if (!string.IsNullOrWhiteSpace(Model.SuccessMessage))
{
    <div class="alert alert-success">@Model.SuccessMessage</div>
}
@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<!-- Stats -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-primary">@Model.TotalCount</div>
                <div class="text-muted small">Total</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-success">@Model.ActiveCount</div>
                <div class="text-muted small">Active</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-danger">@Model.ExpiredCount</div>
                <div class="text-muted small">Expired</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="fs-3 fw-bold text-warning">@Model.CancelledCount</div>
                <div class="text-muted small">Cancelled</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header fw-bold">Subscriptions</div>
    <div class="card-body">

        <!-- Search + Filter -->
        <form method="get" asp-action="BarangaySubscriptions" class="row g-2 align-items-center mb-3">
            <div class="col-12 col-md-8">
                <input name="q" value="@Model.SearchQuery" class="form-control" placeholder="Search barangays..." />
            </div>
            <div class="col-12 col-md-4">
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="all" selected="@(Model.StatusFilter == "all")">All Status</option>
                    <option value="Active" selected="@(Model.StatusFilter == "Active")">Active</option>
                    <option value="Expired" selected="@(Model.StatusFilter == "Expired")">Expired</option>
                    <option value="Cancelled" selected="@(Model.StatusFilter == "Cancelled")">Cancelled</option>
                </select>
            </div>
        </form>

        <div class="table-responsive border rounded">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Barangay</th>
                        <th>Plan</th>
                        <th class="d-none d-md-table-cell">Start Date</th>
                        <th class="d-none d-md-table-cell">End Date</th>
                        <th>Status</th>
                        <th style="width:120px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Subscriptions)
                    {
                        var badgeClass = s.Status == "Active"
                        ? "badge-active"
                        : s.Status == "Expired"
                        ? "badge-expired"
                        : "badge-cancelled";

                        <tr>
                            <td class="fw-semibold">@s.BarangayName</td>
                            <td>@s.PlanName</td>
                            <td class="d-none d-md-table-cell text-muted">@s.StartDate</td>
                            <td class="d-none d-md-table-cell text-muted">@s.EndDate</td>
                            <td><span class="badge @badgeClass">@s.Status</span></td>
                            <td class="text-end">

                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        data-bs-toggle="modal" data-bs-target="#viewModal"
                                        data-id="@s.Id"
                                        data-barangay="@s.BarangayName"
                                        data-plan="@s.PlanName"
                                        data-start="@s.StartDate"
                                        data-end="@s.EndDate"
                                        data-status="@s.Status">
                                    View
                                </button>

                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        data-bs-toggle="modal" data-bs-target="#editModal"
                                        data-id="@s.Id"
                                        data-barangay="@s.BarangayName"
                                        data-plan="@s.PlanName"
                                        data-start="@s.StartDate"
                                        data-end="@s.EndDate">
                                    Edit
                                </button>

                                @if (s.Status == "Active")
                                {
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal" data-bs-target="#cancelModal"
                                            data-id="@s.Id"
                                            data-barangay="@s.BarangayName">
                                        Cancel
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-action="CreateSubscription">
                @Html.AntiForgeryToken()
                <input type="hidden" name="q" value="@Model.SearchQuery" />
                <input type="hidden" name="status" value="@Model.StatusFilter" />

                <div class="modal-header">
                    <h5 class="modal-title">Assign Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Barangay</label>
                            <select class="form-select" name="barangayName" required>
                                <option value="">Select barangay</option>
                                @foreach (var b in Model.Barangays)
                                {
                                    <option value="@b">@b</option>
                                }
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Plan</label>
                            <select class="form-select" name="planName" required>
                                <option value="">Select plan</option>
                                @foreach (var p in Model.Plans)
                                {
                                    <option value="@p">@p</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input class="form-control" type="date" name="startDate" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input class="form-control" type="date" name="endDate" required />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Plan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-action="EditSubscription">
                @Html.AntiForgeryToken()
                <input type="hidden" name="q" value="@Model.SearchQuery" />
                <input type="hidden" name="status" value="@Model.StatusFilter" />
                <input type="hidden" name="id" id="edit_id" />

                <div class="modal-header">
                    <h5 class="modal-title">Edit Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Barangay</label>
                            <select class="form-select" name="barangayName" id="edit_barangay" required>
                                <option value="">Select barangay</option>
                                @foreach (var b in Model.Barangays)
                                {
                                    <option value="@b">@b</option>
                                }
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Plan</label>
                            <select class="form-select" name="planName" id="edit_plan" required>
                                <option value="">Select plan</option>
                                @foreach (var p in Model.Plans)
                                {
                                    <option value="@p">@p</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input class="form-control" type="date" name="startDate" id="edit_start" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input class="form-control" type="date" name="endDate" id="edit_end" required />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- VIEW MODAL -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Subscription Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3 small">
                    <div class="col-6">
                        <div class="text-muted">Barangay:</div>
                        <div class="fw-semibold" id="view_barangay"></div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted">Plan:</div>
                        <div class="fw-semibold" id="view_plan"></div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted">Start Date:</div>
                        <div class="fw-semibold" id="view_start"></div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted">End Date:</div>
                        <div class="fw-semibold" id="view_end"></div>
                    </div>
                </div>

                <div class="mt-3">
                    <span class="badge" id="view_status_badge"></span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- CANCEL MODAL -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="CancelSubscription">
                @Html.AntiForgeryToken()
                <input type="hidden" name="q" value="@Model.SearchQuery" />
                <input type="hidden" name="status" value="@Model.StatusFilter" />
                <input type="hidden" name="id" id="cancel_id" />

                <div class="modal-header">
                    <h5 class="modal-title">Cancel Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    Are you sure you want to cancel the subscription for "<span class="fw-semibold" id="cancel_barangay"></span>"?
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">No, Keep It</button>
                    <button type="submit" class="btn btn-danger">Yes, Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // EDIT modal fill
        const editModal = document.getElementById('editModal');
        editModal?.addEventListener('show.bs.modal', function (event) {
            const btn = event.relatedTarget;
            document.getElementById('edit_id').value = btn.getAttribute('data-id');
            document.getElementById('edit_barangay').value = btn.getAttribute('data-barangay');
            document.getElementById('edit_plan').value = btn.getAttribute('data-plan');
            document.getElementById('edit_start').value = btn.getAttribute('data-start');
            document.getElementById('edit_end').value = btn.getAttribute('data-end');
        });

        // VIEW modal fill
        const viewModal = document.getElementById('viewModal');
        viewModal?.addEventListener('show.bs.modal', function (event) {
            const btn = event.relatedTarget;

            const barangay = btn.getAttribute('data-barangay');
            const plan = btn.getAttribute('data-plan');
            const start = btn.getAttribute('data-start');
            const end = btn.getAttribute('data-end');
            const status = btn.getAttribute('data-status');

            document.getElementById('view_barangay').innerText = barangay;
            document.getElementById('view_plan').innerText = plan;
            document.getElementById('view_start').innerText = start;
            document.getElementById('view_end').innerText = end;

            const badge = document.getElementById('view_status_badge');
            badge.innerText = status;

            badge.className = "badge " + (
                status === "Active" ? "badge-active" :
                status === "Expired" ? "badge-expired" : "badge-cancelled"
            );
        });

        // CANCEL modal fill
        const cancelModal = document.getElementById('cancelModal');
        cancelModal?.addEventListener('show.bs.modal', function (event) {
            const btn = event.relatedTarget;
            document.getElementById('cancel_id').value = btn.getAttribute('data-id');
            document.getElementById('cancel_barangay').innerText = btn.getAttribute('data-barangay');
        });
    </script>
}
