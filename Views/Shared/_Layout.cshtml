@using Microsoft.AspNetCore.Http

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - JAS-MINE</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="~/css/site.css" />

    <style>

        html, body {
            height: 100%;
            margin: 0;
        }

        .app-shell {
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f3f5f7;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            z-index: 40;
            display: none;
        }

        .sidebar-mobile {
            position: fixed;
            width: 260px;
            left: -260px;
            top: 0;
            height: 100%;
            z-index: 50;
            transition: left .3s;
        }

            .sidebar-mobile.open {
                left: 0;
            }

        @@media (min-width: 992px) {
            .sidebar-mobile,
            .sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="app-shell">

        <!-- Desktop Sidebar -->
        <div class="d-none d-lg-block">
            <partial name="_Sidebar" />
        </div>

        <!-- Mobile Sidebar -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <div id="mobileSidebar" class="sidebar-mobile d-lg-none">
            <partial name="_Sidebar" />
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Header -->
            <partial name="_DashboardHeader" />

            <main class="page-content">
                @RenderBody()
            </main>

        </div>
    </div>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        const mobileSidebar = document.getElementById("mobileSidebar");
        const overlay = document.getElementById("sidebarOverlay");

        function openSidebar() {
            mobileSidebar.classList.add("open");
            overlay.style.display = "block";
        }

        function closeSidebar() {
            mobileSidebar.classList.remove("open");
            overlay.style.display = "none";
        }

        overlay?.addEventListener("click", closeSidebar);

        document.addEventListener("click", function (e) {
            if (e.target.closest("#sidebarToggleBtn")) {
                openSidebar();
            }
        });

        // ========== SignalR Real-time Notifications ==========
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .withAutomaticReconnect()
            .build();

        // Handle incoming notifications
        connection.on("ReceiveNotification", function(notification) {
            console.log("Received notification:", notification);

            // Update notification badge count
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                let count = parseInt(badge.textContent) || 0;
                badge.textContent = count + 1;
                badge.classList.remove('d-none');
            }

            // Show toast notification
            showNotificationToast(notification);

            // Add to notification dropdown
            addNotificationToDropdown(notification);
        });

        // Start connection
        connection.start()
            .then(() => console.log("SignalR connected"))
            .catch(err => console.error("SignalR connection error:", err));

        // Toast notification function
        function showNotificationToast(notification) {
            // Create toast container if not exists
            let toastContainer = document.getElementById('notificationToasts');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'notificationToasts';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            const iconClass = notification.Type === 'pending' ? 'bi-clock text-warning' :
                              notification.Type === 'approval' ? 'bi-check-circle text-success' :
                              notification.Type === 'rejected' ? 'bi-x-circle text-danger' :
                              'bi-bell text-primary';

            const toastHtml = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="bi ${iconClass} me-2"></i>
                        <strong class="me-auto">${notification.Title}</strong>
                        <small>${notification.Time}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${notification.Message}
                        ${notification.Link !== '#' ? `<div class="mt-2"><a href="${notification.Link}" class="btn btn-sm btn-primary">View</a></div>` : ''}
                    </div>
                </div>
            `;

            const toastEl = document.createElement('div');
            toastEl.innerHTML = toastHtml;
            toastContainer.appendChild(toastEl.firstElementChild);

            // Auto-remove after 8 seconds
            setTimeout(() => {
                const toast = toastContainer.querySelector('.toast');
                if (toast) toast.remove();
            }, 8000);
        }

        // Add notification to dropdown
        function addNotificationToDropdown(notification) {
            const dropdown = document.querySelector('.dropdown-menu[style*="320px"]');
            if (!dropdown) return;

            const hr = dropdown.querySelector('hr');
            if (!hr) return;

            const iconClass = notification.Type === 'pending' ? 'bi-clock text-warning' :
                              notification.Type === 'approval' ? 'bi-check-circle text-success' :
                              notification.Type === 'rejected' ? 'bi-x-circle text-danger' :
                              'bi-megaphone text-primary';

            const itemHtml = `
                <a href="${notification.Link}" class="dropdown-item small py-2 d-block text-decoration-none" style="white-space: normal;">
                    <div class="d-flex align-items-start gap-2">
                        <span class="bg-success rounded-circle flex-shrink-0 mt-1" style="width:8px;height:8px;"></span>
                        <div>
                            <i class="bi ${iconClass} me-1"></i>
                            <span class="fw-medium text-dark">${notification.Title}</span>
                            <div class="text-muted" style="font-size: 11px;">${notification.Time}</div>
                        </div>
                    </div>
                </a>
            `;

            hr.insertAdjacentHTML('beforebegin', itemHtml);
        }
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
